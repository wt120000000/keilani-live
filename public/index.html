<script type="module">
  import * as DID from "./vendor/client-sdk.mjs";

  const videoEl  = document.getElementById("keilani");
  const sendBtn  = document.getElementById("sendBtn");
  const testBtn  = document.getElementById("testBtn");
  const userText = document.getElementById("userText");
  const statusEl = document.getElementById("status");

  (async () => {
    // 1) fetch env
    const envRes = await fetch("/.netlify/functions/env");
    const { DID_AGENT_ID, DID_CLIENT_KEY } = await envRes.json();

    if (!DID_AGENT_ID || !DID_CLIENT_KEY) {
      statusEl.textContent = "Missing DID vars in Netlify env.";
      return;
    }

    // 2) auth + callbacks
    const auth = { type: "key", clientKey: DID_CLIENT_KEY };
    const callbacks = {
      onSrcObjectReady: (srcObject) => { videoEl.srcObject = srcObject; },
      onVideoStateChange: (s) => { console.log("video:", s); statusEl.textContent = `video: ${s}`; },
      onConnectionStateChange: (s) => { console.log("webrtc:", s); },
      onError: (e) => { console.error("SDK error:", e); statusEl.textContent = (e?.message || e); }
    };

    // 3) force TURN relay to beat strict networks/VPNs
    const rtcConfig = { iceTransportPolicy: "relay" };

    // 4) connect
    const agentManager = await DID.createAgentManager(DID_AGENT_ID, { auth, callbacks, rtcConfig });
    await agentManager.connect();

    // Allow audio
    videoEl.addEventListener("click", () => { videoEl.muted = false; });

    // Test Speak (bypass backend)
    testBtn.onclick = async () => {
      statusEl.textContent = "Testing…";
      await agentManager.speak({ type: "text", input: "Hi co-bro, I am connected!" });
      statusEl.textContent = "Ready.";
    };

    // Send → function → speak
    sendBtn.onclick = async () => {
      const msg = userText.value.trim();
      if (!msg) return;
      statusEl.textContent = "Thinking…";

      const r = await fetch("/.netlify/functions/keilani-reply", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ user: msg })
      });
      if (!r.ok) {
        statusEl.textContent = "Server error. Check OPENAI_API_KEY.";
        return;
      }
      const { text } = await r.json();
      statusEl.textContent = "Speaking…";
      await agentManager.speak({ type: "text", input: text });
      statusEl.textContent = "Ready.";
    };
  })();
</script>
