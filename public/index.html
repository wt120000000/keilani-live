<script type="module">
  import * as DID from "./vendor/client-sdk.mjs";

  document.addEventListener("DOMContentLoaded", () => {
    const videoEl  = document.getElementById("keilani");
    const sendBtn  = document.getElementById("sendBtn");
    const testBtn  = document.getElementById("testBtn");
    const userText = document.getElementById("userText");
    const statusEl = document.getElementById("status");

    (async () => {
      try {
        // 1) Get safe public env (Agent ID + Client Key)
        const envRes = await fetch("/.netlify/functions/env");
        const { DID_AGENT_ID, DID_CLIENT_KEY } = await envRes.json();

        if (!DID_AGENT_ID || !DID_CLIENT_KEY) {
          statusEl.textContent = "Missing DID vars. Set DID_AGENT_ID & DID_CLIENT_KEY in Netlify env.";
          console.error("Missing DID vars:", { DID_AGENT_ID, DID_CLIENT_KEY });
          return;
        }

        // 2) Auth + callbacks
        const auth = { type: "key", clientKey: DID_CLIENT_KEY };
        const callbacks = {
          onSrcObjectReady: (srcObject) => { videoEl.srcObject = srcObject; },
          onVideoStateChange: (s) => { console.log("video:", s); statusEl.textContent = `video: ${s}`; },
          onConnectionStateChange: (s) => { console.log("webrtc:", s); },
          onNewMessage: (messages, type) => { console.log("chat:", type, messages); },
          onError: (e) => { console.error("SDK error:", e); statusEl.textContent = "Error: " + (e?.message || e); },
        };

        // 3) Force TURN relay for strict networks/VPNs
        const rtcConfig = { iceTransportPolicy: "relay" };

        // 4) Create & connect
        const agentManager = await DID.createAgentManager(
          DID_AGENT_ID,
          { auth, callbacks, rtcConfig }
        );
        await agentManager.connect();

        // 5) Unmute on click (autoplay policy)
        videoEl.addEventListener("click", () => { videoEl.muted = false; });

        // 6) Test Speak
        testBtn.onclick = async () => {
          statusEl.textContent = "Testing…";
          await agentManager.speak({ type: "text", input: "Hi co-bro, I am connected!" });
          statusEl.textContent = "Ready.";
        };

        // 7) Send → function → speak
        sendBtn.onclick = async () => {
          const msg = userText.value.trim();
          if (!msg) return;
          statusEl.textContent = "Thinking…";

          const r = await fetch("/.netlify/functions/keilani-reply", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ user: msg })
          });

          if (!r.ok) {
            statusEl.textContent = "Server error. Check OPENAI_API_KEY.";
            console.error("Function error:", await r.text());
            return;
          }

          const { text } = await r.json();
          statusEl.textContent = "Speaking…";
          await agentManager.speak({ type: "text", input: text });
          statusEl.textContent = "Ready.";
        };
      } catch (err) {
        console.error("Init error:", err);
        statusEl.textContent = "Init failed. See console.";
      }
    })();
  });
</script>
